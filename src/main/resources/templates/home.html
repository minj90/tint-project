<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container" layout:fragment="content">
    <div class="container my-5">
        <h2>ë¶€í’ˆ ë°œì£¼ ì˜ˆì¸¡í•˜ê¸°</h2>
        <p>í˜„ì¬ LSTMëª¨ë¸ì€ 3ì¼ì¹˜ ì…ë ¥ ë°ì´í„°ë¥¼ ë³´ê³  ê·¸ ì´í›„ 3ì¼ ë’¤ ì‹œì ì˜ ë°œì£¼ ìˆ˜ëŸ‰ì„ ì˜ˆì¸¡í•˜ë„ë¡ í•™ìŠµë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <form th:object="${request}" method="post">
            <div class="d-flex align-items-baseline">
                <div><h3 class="my-5">ğŸ“¥ ë°œì£¼ ì…ë ¥ </h3></div>
                <div class="mx-md-2 mx-lg-5">
                    <select class="form-control" id="materialSelect" onchange="syncMaterialName(this.value)" th:field="*{orders[0].materialName}" >
                        <option value="">ì›ìì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option th:each="materialName : ${T(com.example.tint.domain.MaterialName).values()}" th:text="${materialName}" th:value="${materialName}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">ì˜ˆì¸¡í•˜ê¸°</button>
            </div>
            <div class="row">
                <div class="col-md">
                    <div class="alert alert-danger" role="alert" th:if="${#fields.hasErrors()}">
                        <div th:each="err : ${#fields.allErrors()}" th:text="${err}"></div>
                    </div>
                    <table id="orderTable" class="table">
                        <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ìˆ˜ëŸ‰</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><input class="form-control" type="date" th:field="*{orders[0].date}"></td>
                            <td><input class="form-control" type="number" th:field="*{orders[0].qty}" ></td>
                            <input type="hidden" th:field="*{orders[0].materialName}" id="material0">
                        </tr>
                        <tr>
                            <td><input class="form-control" type="date" th:field="*{orders[1].date}"></td>
                            <td><input class="form-control" type="number" th:field="*{orders[1].qty}"></td>
                            <input type="hidden" th:field="*{orders[1].materialName}" id="material1">
                        </tr>
                        <tr>
                            <td><input class="form-control" type="date" th:field="*{orders[2].date}"></td>
                            <td><input class="form-control" type="number" th:field="*{orders[2].qty}"></td>
                            <input type="hidden" th:field="*{orders[2].materialName}" id="material2">
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md">
                    <h2 class="mb-5">ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼</h2>
                    <p th:if="${prediction}" th:text="'ì˜ˆì¸¡ ì¼ì (D+3) : ' + ${#temporals.format(predictedDate, 'yyyy-MM-dd')} + ' ì…ë‹ˆë‹¤'"></p>
                    <p th:if="${predictedDate}" th:text="'ì˜ˆì¸¡ëœ ë°œì£¼ ìˆ˜ëŸ‰ : ' + ${#numbers.formatDecimal(prediction, 1, 2)} + 'ê°œ ì…ë‹ˆë‹¤'"></p>
                </div>
            </div>
        </form>
        <hr>
        <div class="text-end">
            <!--        "ë‹¤ì‹œì…ë ¥" ë²„íŠ¼ì€ submitì´ ì•„ë‹Œ GETìœ¼ë¡œ formì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê²Œ í•˜ê¸°-->
            <form th:action="@{/}" method="get">
                <button type="submit" class="btn btn-secondary">ë‹¤ì‹œ ì…ë ¥</button>
            </form>
        </div>
        <script>
            function syncMaterialName(value) {
                document.getElementById("material0").value = value;
                document.getElementById("material1").value = value;
                document.getElementById("material2").value = value;
            }
        </script>
    </div>
    <h2 class="py-4 headerTitle">
        ê³µì •ë¦¬ìŠ¤íŠ¸
        <span class="fs-4">(ì£¼ë¬¸ë²ˆí˜¸ : <span th:text="${jobOrderId}"></span>)</span>
    </h2>
    <div class="row mb-5">
        <div class="col-md-3">
            <h4>ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥ </h4>
            <p th:text="'today : ' +  ${date}"></p>
            <canvas id="myChart4"></canvas>
            <ul>
                <li>ì˜¤ëŠ˜ì˜ ì œí’ˆ : 200</li>
                <li>ì™„ì œí’ˆ ìˆ˜ : <span  id="productCount" th:text="${productCountDate}"></span></li>
            </ul>
        </div>
        <div class="col-md-3">
            <h4>ì œ1ê³µì •</h4>
            <canvas id="myChart1"></canvas>
            <ul>
                <!--        okCountByStep[1] ì—¬ê¸°ì—ì„œì˜ 1ì€ keyì„, 1ì— í•´ë‹¹í•˜ëŠ” ê°’ì„ ê°€ì ¸ì˜¨ë‹¤-->
                <li>ì •ìƒ : <span id="ok-1" th:text="${okCountByStep[1] ?:0}"></span></li>
                <li>ì—ëŸ¬ : <span id="ng-1" th:text="${ngCountByStep[1] ?:0}"></span></li>
                <li>total : <span th:text="${countByStep[1] ?:0}"></span></li>
            </ul>
        </div>
        <div class="col-md-3">
            <h4>ì œ2ê³µì •</h4>
            <canvas id="myChart2"></canvas>
            <ul>
                <li>ì •ìƒ : <span id="ok-2" th:text="${okCountByStep[2] ?:0}"></span></li>
                <li>ì—ëŸ¬ : <span id="ng-2" th:text="${ngCountByStep[2] ?:0}"></span></li>
                <li>total : <span id="total-2" th:text="${countByStep[2] ?:0}"></span></li>
            </ul>
        </div>
        <div class="col-md-3">
            <h4>ì œ3ê³µì •</h4>
            <canvas id="myChart3"></canvas>
            <ul>
                <li>ì •ìƒ : <span id="ok-3" th:text="${okCountByStep[3] ?:0}"></span></li>
                <li>ì—ëŸ¬ : <span id="ng-3" th:text="${ngCountByStep[3] ?:0}"></span></li>
                <li>total : <span id="total-3" th:text="${countByStep[3] ?:0}"></span></li>
            </ul>
        </div>
    </div>
    <div class="table-responsive mb-5">
        <table class="table">
            <thead>
            <tr>
                <th>#</th>
                <th>ì œí’ˆëª…</th>
                <th>lotNumber</th>
                <th>ê³µì •ìŠ¤í…</th>
                <th>ê³µì •ìƒíƒœ</th>
                <th>ê³µì •ìƒì„±ì¼</th>
                <th>ì—ëŸ¬ì½”ë“œ</th>
            </tr>
            </thead>
            <tbody id="tbody">
            <tr th:each="process : ${processes}">
                <td th:text="${process.id}"></td>
                <td th:text="${process.jobOrder.productName}"></td>
                <td th:text="${process.lotNumber}"></td>
                <td th:text="${process.step}"></td>
                <td th:text="${process.status}"></td>
                <td th:text="${#temporals.format(process.processDate,'yyyy-MM-dd hh-mm')}"></td>
                <td th:text="${process.errorCode}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<script th:inline="javascript" layout:fragment="script">
    /*ë°ì´í„° ê°€ì ¸ ì˜¤ê¸°*/
    var error1 = /*[[${ngCountByStep[1] ?: 0}]]*/ 0;
    var ok1 = /*[[${okCountByStep[1] ?: 0}]]*/ 0;

    var error2 = /*[[${ngCountByStep[2] ?: 0}]]*/ 0;
    var ok2 = /*[[${okCountByStep[2] ?: 0}]]*/ 0;

    var error3 = /*[[${ngCountByStep[3] ?: 0}]]*/ 0;
    var ok3 = /*[[${okCountByStep[3] ?: 0}]]*/ 0;

    /* Chart.jsë¡œ ì›í˜• ì°¨íŠ¸ ê·¸ë¦¬ê¸° */
    function drawChart(ctx, ok, error) {
        return new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['ì •ìƒ', 'ì—ëŸ¬'],
                datasets: [{
                    label: 'ê³µì • ìƒíƒœ',
                    data: [ok, error], // OKì™€ ERROR ê°œìˆ˜
                    backgroundColor: ['#0dcaf0', '#ea868f'], // í•˜ëŠ˜(OK), í•‘í¬(ERROR)
                }]
            },
            options: {
                responsive: true
            }
        });
    }

    // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸
    let chart1, chart2, chart3;

    /* ì°¨íŠ¸ ìƒì„± */
    chart1 = drawChart(document.getElementById('myChart1'), ok1, error1);
    chart2 = drawChart(document.getElementById('myChart2'), ok2, error2);
    chart3 = drawChart(document.getElementById('myChart3'), ok3, error3);

    //ì˜¤ëŠ˜ì˜ ë‹¬ì„±ë¥  ë§‰ëŒ€ê·¸ë˜í”„ (ìˆ˜í‰)
    const targetToday = 200;
    let achieved = /*[[${productCountDate}]]*/ 0;

    const chart4 = new Chart(document.getElementById('myChart4'), {
        type: 'bar',
        data: {
            labels: ['ë‹¬ì„±ë¥ '],
            datasets: [{
                label: 'ì™„ì œí’ˆ ìˆ˜',
                data: [achieved],
                backgroundColor: '#0dcaf0',
                maxBarThickness: 30
            }]
        },
        options: {
            indexAxis: 'y',
            scales: {
                x: {
                    max: targetToday,
                    title: {
                        display: true,
                        text: `ëª©í‘œ: ${targetToday}ê°œ`
                    }
                },
                y: {
                    ticks: { display: false }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.parsed.x}ê°œ / ${targetToday}ê°œ`
                    }
                }
            }
        }
    });

    // lotNumberë³„ step ìƒíƒœ ëˆ„ì  ì €ì¥
    const lotStepStatusMap = {}; // { lotNumberBase: {1: "OK", 2: "OK", 3: "OK"} }

    //ì›¹ì†Œì¼“, ìë™í™”ë©´ì—…ë°ì´íŠ¸
    const socket = new SockJS("/ws");
    const stomp = Stomp.over(socket);

    stomp.connect({}, () => {
        stomp.subscribe("/topic/process", (msg) => {
            const p = JSON.parse(msg.body);
            // ì—¬ê¸°ì„œ step, statusë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë™ì ìœ¼ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸
            console.log("ì‹¤ì‹œê°„ ì²˜ë¦¬ë¨:", msg.body);
            // ì˜ˆ: document.querySelector("#chart").updateChart(p);
            // {"lotNumber":"PINKTINT_6_010_01_20250516","step":1,"status":"OK","processDate":"2025-05-16T16:26:23.514135300","errorCode":"_","productName":"PINKTINT"}

            // ê³µì •ë³„ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            const step = p.step;
            const status = p.status;
            const lotNumber = p.lotNumber;

            // lotNumberì—ì„œ base ì¶”ì¶œ
            const base = lotNumber.split("_").slice(0, 3).join("_");   //"PINKTINT_33_001"
            console.log(base)
            console.log(lotStepStatusMap[base])

            if (!lotStepStatusMap[base]) lotStepStatusMap[base] = {};
            lotStepStatusMap[base][step] = status;

            // ì™„ì œí’ˆ íŒë³„: step1, 2, 3ì´ ëª¨ë‘ OKì¼ ë•Œë§Œ ì¹´ìš´íŒ…
            const stepStatus = lotStepStatusMap[base];
            const today = new Date().toISOString().split("T")[0];

            if (
                p.processDate &&
                p.processDate.startsWith(today) &&
                stepStatus[1] === "OK" &&
                stepStatus[2] === "OK" &&
                stepStatus[3] === "OK" &&
                step === 3 // ë§ˆì§€ë§‰ ê³µì •ì—ì„œë§Œ ì²˜ë¦¬
            ) {
                chart4.data.datasets[0].data[0]++;
                chart4.update();

                const span = document.getElementById("productCount");
                if (span) {
                    span.textContent = parseInt(span.textContent || '0') + 1;
                }
            }


            // ê³µì •ë³„ ì¹´ìš´í„° ë° í…Œì´ë¸”
            const okSpan = document.querySelector(`#ok-${step}`);
            const ngSpan = document.querySelector(`#ng-${step}`);
            const totalSpan = document.querySelector(`#total-${step}`);

            if (status === 'OK' && okSpan) okSpan.textContent = parseInt(okSpan.textContent) + 1;
            if (status === 'NG' && ngSpan) ngSpan.textContent = parseInt(ngSpan.textContent) + 1;
            if (totalSpan) totalSpan.textContent = parseInt(totalSpan.textContent) + 1;

            // í…Œì´ë¸”ì— í•œ ì¤„ ì¶”ê°€
            const tbody = document.querySelector("table #tbody");
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>-</td>
            <td>${p.productName}</td>
            <td>${p.lotNumber}</td>
            <td>${p.step}</td>
            <td>${p.status}</td>
            <td>${p.processDate || '-'}</td>
            <td>${p.errorCode}</td>
        `;
            tbody.prepend(tr);

            //ì°¨íŠ¸ ì¶”ê°€
            const targetChart = step === 1 ? chart1 : step === 2 ? chart2 : chart3;
            if (targetChart) {
                if (status === 'OK') targetChart.data.datasets[0].data[0]++;
                else targetChart.data.datasets[0].data[1]++;
                targetChart.update();
            }


        });
    });


</script>
</html>